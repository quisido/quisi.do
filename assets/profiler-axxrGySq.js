import{w as J,a2 as x,a3 as z,a4 as H,a5 as m,A as I,a6 as W,a7 as v,a8 as X,X as q,W as K,a9 as Q,aa as Y,ab as Z}from"./index-Be4i7263.js";function $(t){let n=0;for(const i of t)i.stackId!==void 0&&n++;return n}const g=new Map;function ee(t,n){g.set(n,t)}function te(t){return g.get(t)}function E(t){for(const n of g.keys())n<t&&g.delete(n)}function ne({rawRumEvent:t,startTime:n}){if(t.type!=="long_task")return;const i=t.long_task.id;ee(i,n)}const se=(t,n,i,s)=>{const f=oe(t,n,i,s),c=re(t,f),l=n.build("fetch",c);return J("Sending profile to public profiling intake",{profilingIntakeURL:l,applicationId:i,sessionId:s}),fetch(l,{body:c.data,method:"POST"})};function oe(t,n,i,s){const f=n.tags,c=ie(t,i,s),l=ae(f);return{...c,attachments:["wall-time.json"],start:new Date(t.startClocks.timeStamp).toISOString(),end:new Date(t.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:l.join(","),_dd:{clock_drift:x()}}}function ae(t){return t.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function re(t,n){const i=new Blob([JSON.stringify(t)],{type:"application/json"}),s=new FormData;return s.append("event",new Blob([JSON.stringify(n)],{type:"application/json"}),"event.json"),s.append("wall-time.json",i,"wall-time.json"),{data:s,bytesCount:0}}function ie(t,n,i){const s={application:{id:n}};i&&(s.session={id:i});const f=Array.from(new Set(t.views.map(l=>l.viewId)));f.length&&(s.view={id:f});const c=t.longTasks.map(l=>l.id).filter(l=>l!==void 0);return c.length&&(s.long_task={id:c}),s}const le={sendProfile:se},ce={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function de(t,n,i,s=ce){const f=z(H.LONG_ANIMATION_FRAME);let c;const l=[];let a={state:"stopped"};function O(e){a.state!=="running"&&(c=e?{startClocks:e.startClocks,viewId:e.id,viewName:e.name}:void 0,l.push(I(t,window,"visibilitychange",D).stop,I(t,window,"beforeunload",j).stop),p())}async function L(){await h("stopped"),l.forEach(e=>e()),E(m().relative)}function M(e){if(e.state==="running")return{cleanupTasks:e.cleanupTasks,observer:e.observer};const o=[];let r;if(t.trackLongTasks){r=new PerformanceObserver(N),r.observe({entryTypes:[R()]});const d=n.subscribe(12,b=>{ne(b)});o.push(()=>r==null?void 0:r.disconnect()),o.push(d.unsubscribe)}const u=n.subscribe(2,d=>{T({viewId:d.id,viewName:d.name,startClocks:d.startClocks})});return o.push(u.unsubscribe),{cleanupTasks:o,observer:r}}function p(){const e=W().Profiler;if(!e)throw new Error("RUM Profiler is not supported in this browser.");k(a).catch(v);const{cleanupTasks:o,observer:r}=M(a);let u;try{u=new e({sampleInterval:s.sampleIntervalMs,maxBufferSize:Math.round(s.collectIntervalMs*1.5/s.sampleIntervalMs)})}catch(d){X.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",d);return}a={state:"running",startClocks:m(),profiler:u,timeoutId:q(p,s.collectIntervalMs),longTasks:[],views:[],cleanupTasks:o,observer:r},T(c),u.addEventListener("samplebufferfull",w)}async function k(e){var o,r;if(e.state!=="running")return;y((r=(o=e.observer)===null||o===void 0?void 0:o.takeRecords())!==null&&r!==void 0?r:[]),K(e.timeoutId),e.profiler.removeEventListener("samplebufferfull",w);const{startClocks:u,longTasks:d,views:b}=e,F=m();await e.profiler.stop().then(S=>{const P=m(),U=d.length>0,G=Q(u.timeStamp,P.timeStamp)<s.minProfileDurationMs,V=$(S.samples)<s.minNumberOfSamples;!U&&(G||V)||(_(Object.assign(S,{startClocks:u,endClocks:P,clocksOrigin:Y(),longTasks:d,views:b,sampleInterval:s.sampleIntervalMs})),E(F.relative))}).catch(v)}async function h(e){a.state==="running"&&(a.cleanupTasks.forEach(o=>o()),await k(a),a={state:e})}function T(e){a.state!=="running"||!e||a.views.push(e)}function _(e){var o;const r=(o=i.findTrackedSession())===null||o===void 0?void 0:o.id;le.sendProfile(e,t.profilingEndpointBuilder,t.applicationId,r).catch(v)}function w(){p()}function N(e){y(e.getEntries())}function y(e){if(a.state==="running")for(const o of e){if(o.duration<s.sampleIntervalMs)continue;const r=Z(o.startTime),u=te(r.relative);a.longTasks.push({id:u,duration:o.duration,entryType:o.entryType,startClocks:r})}}function D(){document.visibilityState==="hidden"&&a.state==="running"?h("paused").catch(v):document.visibilityState==="visible"&&a.state==="paused"&&p()}function j(){p()}function R(){return f?"long-animation-frame":"longtask"}function A(){return a.state==="stopped"}function C(){return a.state==="running"}function B(){return a.state==="paused"}return{start:O,stop:L,isStopped:A,isRunning:C,isPaused:B}}export{ce as DEFAULT_RUM_PROFILER_CONFIGURATION,de as createRumProfiler};
//# sourceMappingURL=profiler-axxrGySq.js.map
